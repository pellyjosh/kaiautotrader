{% extends "base.html" %}

{% block title %}Change Password - HuboluxTradingBot{% endblock %}

{% block extra_css %}
<style>
    .password-form {
        background: rgba(17, 17, 17, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border-primary);
        border-radius: 12px;
        padding: 2rem;
        max-width: 500px;
        margin: 2rem auto;
    }

    .form-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .form-header h1 {
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-weight: 700;
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
    }

    .form-header p {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    .form-label {
        color: var(--text-secondary);
        font-family: var(--font-mono);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .form-control {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        color: var(--text-primary);
        font-family: var(--font-mono);
        padding: 0.75rem;
        transition: var(--transition-fast);
    }

    .form-control:focus {
        background: var(--bg-secondary);
        border-color: var(--text-success);
        color: var(--text-primary);
        box-shadow: 0 0 0 0.2rem rgba(0, 255, 136, 0.25);
    }

    .form-control::placeholder {
        color: var(--text-muted);
        font-style: italic;
    }

    .password-strength {
        margin-top: 0.5rem;
    }

    .strength-bar {
        height: 4px;
        background: var(--bg-secondary);
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 0.25rem;
    }

    .strength-fill {
        height: 100%;
        transition: var(--transition-fast);
        border-radius: 2px;
    }

    .strength-weak {
        background: var(--text-error);
        width: 25%;
    }

    .strength-fair {
        background: var(--text-warning);
        width: 50%;
    }

    .strength-good {
        background: var(--text-info);
        width: 75%;
    }

    .strength-strong {
        background: var(--text-success);
        width: 100%;
    }

    .strength-text {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-style: italic;
    }

    .btn-change {
        background: linear-gradient(135deg, var(--text-success), #00cc66);
        border: none;
        color: var(--bg-primary);
        padding: 0.75rem 2rem;
        border-radius: 6px;
        font-family: var(--font-mono);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: var(--transition-fast);
        width: 100%;
        margin-bottom: 1rem;
    }

    .btn-change:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        opacity: 0.9;
        color: var(--bg-primary);
    }

    .btn-cancel {
        background: transparent;
        border: 1px solid var(--border-primary);
        color: var(--text-secondary);
        padding: 0.75rem 2rem;
        border-radius: 6px;
        font-family: var(--font-mono);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: var(--transition-fast);
        text-decoration: none;
        width: 100%;
        text-align: center;
        display: block;
    }

    .btn-cancel:hover {
        border-color: var(--text-warning);
        color: var(--text-warning);
        text-decoration: none;
    }

    .alert {
        background: rgba(255, 68, 68, 0.1);
        border: 1px solid var(--text-error);
        color: var(--text-error);
        border-radius: 6px;
        font-family: var(--font-mono);
        margin-bottom: 1.5rem;
    }

    .alert-success {
        background: rgba(0, 255, 136, 0.1);
        border-color: var(--text-success);
        color: var(--text-success);
    }

    .password-requirements {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .requirements-title {
        color: var(--text-secondary);
        font-family: var(--font-mono);
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .requirement {
        display: flex;
        align-items: center;
        color: var(--text-muted);
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
    }

    .requirement i {
        margin-right: 0.5rem;
        width: 15px;
    }

    .requirement.met {
        color: var(--text-success);
    }

    .requirement.met i {
        color: var(--text-success);
    }

    .input-group-text {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        color: var(--text-secondary);
    }

    .toggle-password {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        padding: 0;
        cursor: pointer;
        transition: var(--transition-fast);
    }

    .toggle-password:hover {
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="password-form">
        <div class="form-header">
            <h1><i class="fas fa-key me-2"></i>Change Password</h1>
            <p>Update your account password for enhanced security</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert {% if category == 'success' %}alert-success{% endif %} alert-dismissible fade show"
            role="alert">
            <i
                class="fas fa-{% if category == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('auth.change_password') }}" id="changePasswordForm">
            <div class="mb-3">
                <label for="current_password" class="form-label">
                    <i class="fas fa-lock me-2"></i>Current Password *
                </label>
                <div class="input-group">
                    <input type="password" class="form-control" id="current_password" name="current_password" required
                        placeholder="Enter your current password">
                    <span class="input-group-text">
                        <button type="button" class="toggle-password" data-target="current_password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </span>
                </div>
            </div>

            <div class="mb-3">
                <label for="new_password" class="form-label">
                    <i class="fas fa-key me-2"></i>New Password *
                </label>
                <div class="input-group">
                    <input type="password" class="form-control" id="new_password" name="new_password" required
                        placeholder="Enter your new password">
                    <span class="input-group-text">
                        <button type="button" class="toggle-password" data-target="new_password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </span>
                </div>
                <div class="password-strength">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strengthFill"></div>
                    </div>
                    <div class="strength-text" id="strengthText">Password strength will be shown here</div>
                </div>
            </div>

            <div class="mb-3">
                <label for="confirm_password" class="form-label">
                    <i class="fas fa-check-double me-2"></i>Confirm New Password *
                </label>
                <div class="input-group">
                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" required
                        placeholder="Confirm your new password">
                    <span class="input-group-text">
                        <button type="button" class="toggle-password" data-target="confirm_password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </span>
                </div>
                <div id="passwordMatch" class="strength-text" style="margin-top: 0.5rem;"></div>
            </div>

            <div class="password-requirements">
                <div class="requirements-title">Password Requirements:</div>
                <div class="requirement" id="req-length">
                    <i class="fas fa-times"></i>
                    At least 8 characters long
                </div>
                <div class="requirement" id="req-lowercase">
                    <i class="fas fa-times"></i>
                    Contains lowercase letter
                </div>
                <div class="requirement" id="req-uppercase">
                    <i class="fas fa-times"></i>
                    Contains uppercase letter
                </div>
                <div class="requirement" id="req-number">
                    <i class="fas fa-times"></i>
                    Contains number
                </div>
                <div class="requirement" id="req-special">
                    <i class="fas fa-times"></i>
                    Contains special character
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn-change">
                    <i class="fas fa-save me-2"></i>Change Password
                </button>
                <a href="{{ url_for('main.dashboard') }}" class="btn-cancel">
                    <i class="fas fa-arrow-left me-2"></i>Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('changePasswordForm');
        const submitBtn = document.querySelector('.btn-change');
        const newPasswordInput = document.getElementById('new_password');
        const confirmPasswordInput = document.getElementById('confirm_password');
        const strengthFill = document.getElementById('strengthFill');
        const strengthText = document.getElementById('strengthText');
        const passwordMatch = document.getElementById('passwordMatch');

        // Password toggle functionality
        document.querySelectorAll('.toggle-password').forEach(btn => {
            btn.addEventListener('click', function () {
                const targetId = this.getAttribute('data-target');
                const targetInput = document.getElementById(targetId);
                const icon = this.querySelector('i');

                if (targetInput.type === 'password') {
                    targetInput.type = 'text';
                    icon.className = 'fas fa-eye-slash';
                } else {
                    targetInput.type = 'password';
                    icon.className = 'fas fa-eye';
                }
            });
        });

        // Form submission handling
        form.addEventListener('submit', function (e) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Changing...';
            submitBtn.disabled = true;
        });

        // Password strength checker
        newPasswordInput.addEventListener('input', function () {
            const password = this.value;
            const strength = checkPasswordStrength(password);
            updatePasswordRequirements(password);

            // Remove existing strength classes
            strengthFill.className = 'strength-fill';

            if (password.length === 0) {
                strengthText.textContent = 'Password strength will be shown here';
                return;
            }

            switch (strength.level) {
                case 1:
                    strengthFill.classList.add('strength-weak');
                    strengthText.textContent = 'Weak password - needs improvement';
                    break;
                case 2:
                    strengthFill.classList.add('strength-fair');
                    strengthText.textContent = 'Fair password - could be stronger';
                    break;
                case 3:
                    strengthFill.classList.add('strength-good');
                    strengthText.textContent = 'Good password - quite secure';
                    break;
                case 4:
                    strengthFill.classList.add('strength-strong');
                    strengthText.textContent = 'Strong password - excellent!';
                    break;
            }
        });

        // Password confirmation checker
        function checkPasswordMatch() {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (confirmPassword.length === 0) {
                passwordMatch.textContent = '';
                passwordMatch.style.color = '';
                return;
            }

            if (newPassword === confirmPassword) {
                passwordMatch.textContent = '✓ Passwords match';
                passwordMatch.style.color = 'var(--text-success)';
            } else {
                passwordMatch.textContent = '✗ Passwords do not match';
                passwordMatch.style.color = 'var(--text-error)';
            }
        }

        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
        newPasswordInput.addEventListener('input', checkPasswordMatch);

        function checkPasswordStrength(password) {
            let score = 0;

            if (password.length >= 8) score++;
            if (password.match(/[a-z]/)) score++;
            if (password.match(/[A-Z]/)) score++;
            if (password.match(/[0-9]/)) score++;
            if (password.match(/[^a-zA-Z0-9]/)) score++;

            return {
                level: Math.min(4, Math.max(1, score - 1)),
                score: score
            };
        }

        function updatePasswordRequirements(password) {
            const requirements = [
                { id: 'req-length', test: password.length >= 8 },
                { id: 'req-lowercase', test: /[a-z]/.test(password) },
                { id: 'req-uppercase', test: /[A-Z]/.test(password) },
                { id: 'req-number', test: /[0-9]/.test(password) },
                { id: 'req-special', test: /[^a-zA-Z0-9]/.test(password) }
            ];

            requirements.forEach(req => {
                const element = document.getElementById(req.id);
                const icon = element.querySelector('i');

                if (req.test) {
                    element.classList.add('met');
                    icon.className = 'fas fa-check';
                } else {
                    element.classList.remove('met');
                    icon.className = 'fas fa-times';
                }
            });
        }
    });
</script>
{% endblock %}